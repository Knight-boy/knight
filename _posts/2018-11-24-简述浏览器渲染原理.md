---
layout: post
title:  "简述浏览器渲染原理"
date: 2018-11-24
excerpt: "从地址栏到页面呈现过程"
tag:
- 前端
---

### 浏览器的高级架构

​	浏览器的主要组件是：

1. **用户界面(The user interface)**：这包括地址栏，后退/前进按钮，书签菜单等。浏览器的每个部分都显示除了您看到所请求页面的窗口。
2. **浏览器引擎(The browser engine)**: 在UI和渲染引擎之间进行编组操作。
3. **渲染引擎(The rendering engine)**：负责显示请求的内容。例如，如果请求的内容是HTML，则呈现引擎解析HTML和CSS，并在屏幕上显示解析的内容。
4. **网络(Networking)**：用于网络调用，例如HTTP请求，在独立于平台的界面后面使用不同平台的不同实现。
5. **UI后端(UI backend)**：用于绘制组合框和窗口等基本小部件。此后端公开了一个非平台特定的通用接口。它下面使用操作系统用户界面方法。
6. **JavaScript解释器(Javascript interpreter)**。用于解析和执行JavaScript代码。
7. **数据存储(Data storage)**。这是一个持久层。浏览器可能需要在本地保存各种数据，例如cookie。浏览器还支持存储机制，例如localStorage，IndexedDB，WebSQL和FileSystem。

![浏览器组件](https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/layers.png)

<center><b>图0 </b>浏览器组件</center>

### 渲染引擎

​	不同的浏览器使用不同的渲染引擎：Internet Explorer使用Trident，Firefox使用Gecko，Safari使用WebKit。Chrome和Opera（来自15版）使用Blink，一个WebKit的分支。

​	WebKit是一个开源渲染引擎，起初是Linux平台的引擎，并由Apple修改以支持Mac和Windows。有关详细信息，请参阅[webkit.org](http://webkit.org/)。	

### 主流程(The main flow)

​	渲染引擎首先通过网络获得所请求文档的内容，通常以8K分块的方式完成。渲染引擎在获取内容后的基本流程如下：

​	解析html用以构建DOM树，然后构建Render树(呈现树)，接着布局Render树，最后绘制Render树。流程如**图1**所示。

![渲染流程](https://pic002.cnblogs.com/images/2011/265173/2011110316263715.png)

<center><b>图1 </b>渲染引擎基本流程</center>

- 首先渲染引擎开始解析html文件，并将html标签转化为内容树中的DOM节点。接着，它解析外部CSS文件及Style标签中的样式信息。这些样式信息以及html中的可见性指令将被用来构建另一棵树-Render树。

- Render树由一些包含有颜色和大小等属性的矩形区域块组成，它们将被按照正确的顺序显示到屏幕上。

- Render树构建好了之后，将会执行Render树布局，它将确定每个节点在屏幕上的确切坐标。再下一步就是绘制，即遍历Render树，并使用UI后端层绘制每个节点。

- 值得注意的是，这个过程是逐步完成的，为了更好的用户体验，渲染引擎将会尽可能早的将内容呈现到屏幕上，并不会等到所有的html都解析完成之后再去构建和布局Render树。它是边解析边显示，解析一部分内容就显示一部分内容，同时，可能还会通过网络下载其余内容。

![Webkit引擎解析模式](https://pic002.cnblogs.com/images/2011/265173/2011110316264892.png)

<center><b>图2 </b>Webkit引擎渲染主流程</center>

![Gecko渲染主流程](https://pic002.cnblogs.com/images/2011/265173/2011110316270146.jpg)

<center><b>图3 </b>Gecko引擎渲染主流程</center>

​	从**图2**和**图3**中可以看出，尽管Webkit和Gecko使用的术语稍有不同，他们的主要流程基本相同。Gecko称可见的格式化元素组成的树为frame树，每个元素都是一个frame，Webkit则使用Render树这个名词来命名由渲染对象组成的树。Webkit中元素的定位称为布局，而Gecko中称为回流。Webkit称利用DOM节点及样式信息去构建Render树的过程为attachment，Geoko在html和DOM树之间附加了一层，这层称为内容接收器，相当制造DOM元素的工厂。

### Origin

[浏览器内部工作原理](https://kb.cnblogs.com/page/129756/)

[How Browsers Work: Behind the scenes of modern web browsers](https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/)